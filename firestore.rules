rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to get user role
    function getUserRole() {
      // Assuming user role is stored in a 'users' collection with document ID matching auth uid
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    match /spaces/{spaceId} {
      // Anyone logged in can read
      allow read: if request.auth != null;
      // Only admins can create, update, or delete spaces
      allow write: if request.auth != null && getUserRole() == 'admin';
    }

    match /projects/{projectId} {
      allow read: if request.auth != null;
      // Only admins can create, update, or delete projects
      allow write: if request.auth != null && getUserRole() == 'admin';
    }

    match /tasks/{taskId} {
      allow read: if request.auth != null;
      // Employees can create and update tasks, but only admins can delete them
      allow create, update: if request.auth != null;
      allow delete: if request.auth != null && getUserRole() == 'admin';
      
      // Sub-collections under tasks (e.g., comments, activities)
      match /comments/{commentId} {
        allow read, write: if request.auth != null;
      }
      match /activities/{activityId} {
        allow read, write: if request.auth != null;
      }
    }

    match /users/{userId} {
      allow read: if request.auth != null;
      // Users can update their own status/profile, admins can update anything
      allow write: if request.auth != null && (request.auth.uid == userId || getUserRole() == 'admin');
    }
  }
}
